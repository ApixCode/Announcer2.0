<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Announcer Dashboard</title>
    <link rel="stylesheet" href="style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="aurora-background">
        <div class="aurora__item"></div>
        <div class="aurora__item"></div>
        <div class="aurora__item"></div>
        <div class="aurora__item"></div>
    </div>
    
    <div class="container">
        <div class="dashboard-container">

            <!-- VIEW 1: Webhook List (Main View) -->
            <div id="webhookListContainer">
                <div class="dashboard-header">
                    <h1 class="title-glow" style="font-size: 2em; margin: 0;">My Webhooks</h1>
                    <div class="header-actions">
                        <button id="importBtn" class="cool-button btn-danger"><span>Import</span></button>
                        <button id="exportBtn" class="cool-button btn-danger"><span>Export</span></button>
                        <button id="showAddWebhookModalBtn" class="cool-button"><span>+ Add New</span></button>
                    </div>
                </div>
                <div id="webhookList">
                    <!-- Webhook cards will be injected here -->
                </div>
                <div id="noWebhooksMessage" class="hidden">
                    <h2>No webhooks found.</h2>
                    <p>Click "+ Add New" to get started or import a configuration file!</p>
                </div>
            </div>

            <!-- VIEW 2: Announcement Form -->
            <div id="announcementFormContainer" class="hidden">
                 <div class="dashboard-header">
                     <h2 id="formTitle" style="margin: 0;">Create Announcement</h2>
                     <button id="backToDashboardBtn" class="cool-button btn-danger"><span>&larr; Back</span></button>
                </div>
                <form id="announcementForm">
                    <div class="form-section">
                        <label for="messageContent">Message Content (Optional)</label>
                        <textarea id="messageContent" placeholder="You can use @everyone, @here, etc."></textarea>
                    </div>
                    <div class="form-section">
                        <h3>Embed Message (Optional)</h3>
                        <div class="color-picker-group">
                           <label for="embedColor">Embed Color</label>
                           <input type="color" id="embedColor" value="#ff004c">
                        </div>
                        <label for="embedTitle">Title</label><input type="text" id="embedTitle">
                        <label for="embedDescription">Description</label><textarea id="embedDescription" placeholder="Supports Markdown. e.g., **bold**"></textarea>
                        <label for="embedAuthor">Author</label><input type="text" id="embedAuthor">
                        <label for="embedAuthorIcon">Author Icon URL</label><input type="url" id="embedAuthorIcon">
                        <label for="embedImage">Image URL</label><input type="url" id="embedImage">
                        <label for="embedThumbnail">Thumbnail URL</label><input type="url" id="embedThumbnail">
                        <label for="embedFooter">Footer</label><input type="text" id="embedFooter">
                        <label for="embedFooterIcon">Footer Icon URL</label><input type="url" id="embedFooterIcon">
                    </div>
                    <div class="form-section">
                        <h3>Embed Fields</h3>
                        <div id="fieldsContainer" class="field-container"></div>
                        <div class="button-group">
                            <button type="button" id="addFieldBtn" class="cool-button"><span>Add Field</span></button>
                        </div>
                    </div>
                    <div class="button-group">
                        <button type="submit" class="cool-button"><span>Send Announcement</span></button>
                    </div>
                </form>
            </div>
            
            <div id="statusMessage" class="status-message hidden"></div>
        </div>
    </div>

    <!-- MODAL for adding webhook -->
    <div id="webhookModal" class="modal-overlay">
        <div class="glass-card modal-content">
            <h2 id="modalTitle">Add New Webhook</h2>
            <form id="webhookForm">
                <div class="input-group"><input type="url" id="webhookUrlInput" required><label>Webhook URL</label></div>
                <div class="input-group"><input type="text" id="webhookNameInput" required><label>Display Name (e.g., #announcements)</label></div>
                <div class="button-group">
                    <button type="submit" class="cool-button"><span>Save</span></button>
                    <button type="button" id="closeModalBtn" class="cool-button btn-danger"><span>Cancel</span></button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Hidden file input for import -->
    <input type="file" id="importFileInput" class="hidden" accept=".json">

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- STATE & DOM ELEMENTS ---
            let webhooks = [];
            let activeWebhookId = null;
            let isEditingLastMessage = false;

            const webhookList = document.getElementById('webhookList');
            const webhookForm = document.getElementById('webhookForm');
            const announcementForm = document.getElementById('announcementForm');
            const statusMessage = document.getElementById('statusMessage');
            
            // --- DATA & PERSISTENCE (localStorage + Import/Export) ---
            const loadWebhooks = () => {
                webhooks = JSON.parse(localStorage.getItem('webhooks')) || [];
            };

            const saveWebhooks = () => {
                localStorage.setItem('webhooks', JSON.stringify(webhooks));
            };

            const handleExport = () => {
                if (webhooks.length === 0) {
                    showStatus('Nothing to export!', 'error');
                    return;
                }
                const dataStr = JSON.stringify(webhooks, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.download = 'webhooks-config.json';
                link.href = url;
                link.click();
                URL.revokeObjectURL(url);
                showStatus('Webhooks exported successfully!', 'success');
            };

            const handleImport = (event) => {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        if (!Array.isArray(importedData)) throw new Error("Invalid format");
                        if (confirm("This will overwrite your current webhooks. Are you sure?")) {
                            webhooks = importedData;
                            saveWebhooks();
                            renderWebhookList();
                            showStatus('Webhooks imported successfully!', 'success');
                        }
                    } catch (err) {
                        showStatus('Failed to import: Invalid JSON file.', 'error');
                    }
                };
                reader.readAsText(file);
                event.target.value = null; // Reset input
            };

            // --- UI RENDERING & VIEW MANAGEMENT ---
            const renderWebhookList = () => {
                webhookList.innerHTML = '';
                document.getElementById('noWebhooksMessage').classList.toggle('hidden', webhooks.length > 0);
                webhooks.forEach((wh, index) => {
                    const card = document.createElement('div');
                    card.className = 'webhook-card';
                    card.style.setProperty('--x', '50%');
                    card.style.setProperty('--y', '50%');
                    card.style.animationDelay = `${index * 50}ms`;
                    card.innerHTML = `
                        <h3>${wh.name}</h3><p>${wh.url}</p>
                        <div class="card-actions">
                            <button class="cool-button announce-btn" data-id="${wh.id}"><span>Announce</span></button>
                            ${wh.lastMessageId ? `<button class="cool-button edit-last-btn" data-id="${wh.id}"><span>Edit Last</span></button>` : ''}
                            <button class="cool-button btn-danger delete-btn" data-id="${wh.id}"><span>Delete</span></button>
                        </div>`;
                    webhookList.appendChild(card);
                });
            };
            
            const showView = (view) => {
                document.getElementById('webhookListContainer').classList.toggle('hidden', view !== 'webhookListContainer');
                document.getElementById('announcementFormContainer').classList.toggle('hidden', view !== 'announcementFormContainer');
            };

            const showStatus = (message, type = 'success') => {
                statusMessage.textContent = message;
                statusMessage.className = `status-message status-${type}`;
                statusMessage.classList.remove('hidden');
                setTimeout(() => statusMessage.classList.add('hidden'), 4000);
            };

            // --- ANNOUNCEMENT FORM LOGIC ---
            const prepareAnnouncementForm = (webhookId, isEditing = false) => {
                activeWebhookId = webhookId;
                isEditingLastMessage = isEditing;
                const webhook = webhooks.find(wh => wh.id === webhookId);
                
                document.getElementById('formTitle').textContent = isEditing ? `Edit last in: ${webhook.name}` : `Announce to: ${webhook.name}`;
                announcementForm.reset();
                document.getElementById('fieldsContainer').innerHTML = '';

                if (isEditing && !webhook.lastMessageId) {
                    showStatus('No last message found to edit for this webhook!', 'error');
                    return;
                }
                showView('announcementFormContainer');
            };

            const handleSendAnnouncement = async (e) => {
                e.preventDefault();
                const webhook = webhooks.find(wh => wh.id === activeWebhookId);
                if (!webhook) return;

                const hexColor = document.getElementById('embedColor').value;
                const decimalColor = parseInt(hexColor.substring(1), 16);

                const payload = {
                    content: document.getElementById('messageContent').value || null,
                    embeds: []
                };

                const embed = {
                    title: document.getElementById('embedTitle').value,
                    description: document.getElementById('embedDescription').value,
                    color: decimalColor,
                    author: { name: document.getElementById('embedAuthor').value, icon_url: document.getElementById('embedAuthorIcon').value },
                    image: { url: document.getElementById('embedImage').value },
                    thumbnail: { url: document.getElementById('embedThumbnail').value },
                    footer: { text: document.getElementById('embedFooter').value, icon_url: document.getElementById('embedFooterIcon').value },
                    fields: Array.from(document.querySelectorAll('.field-item')).map(item => ({
                        name: item.querySelector('.field-name').value,
                        value: item.querySelector('.field-value').value,
                        inline: item.querySelector('.field-inline').checked
                    })).filter(f => f.name && f.value)
                };

                if (Object.values(embed).some(val => (typeof val === 'string' && val) || (Array.isArray(val) && val.length > 0) || (typeof val === 'object' && Object.values(val).some(v => v)))) {
                    payload.embeds.push(embed);
                }

                if (!payload.content && payload.embeds.length === 0) {
                    return showStatus('You must provide some content or embed data!', 'error');
                }

                let webhookUrl = webhook.url + (isEditingLastMessage ? `/messages/${webhook.lastMessageId}` : '?wait=true');
                try {
                    const response = await fetch(webhookUrl, {
                        method: isEditingLastMessage ? 'PATCH' : 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (response.ok) {
                        if (!isEditingLastMessage) {
                            const data = await response.json();
                            webhook.lastMessageId = data.id;
                            saveWebhooks();
                        }
                        showStatus(isEditingLastMessage ? 'Message edited!' : 'Announcement sent!', 'success');
                        showView('webhookListContainer');
                        renderWebhookList();
                    } else {
                        const errorData = await response.json();
                        showStatus(`Error: ${JSON.stringify(errorData.message || errorData)}`, 'error');
                    }
                } catch (error) {
                    showStatus('Network error. Check console and URL.', 'error');
                }
            };

            // --- EVENT LISTENERS ---
            // Modal
            const modal = document.getElementById('webhookModal');
            document.getElementById('showAddWebhookModalBtn').addEventListener('click', () => modal.classList.add('active'));
            document.getElementById('closeModalBtn').addEventListener('click', () => modal.classList.remove('active'));
            modal.addEventListener('click', (e) => { if(e.target === modal) modal.classList.remove('active'); });
            
            webhookForm.addEventListener('submit', (e) => {
                e.preventDefault();
                webhooks.push({ id: Date.now(), name: document.getElementById('webhookNameInput').value, url: document.getElementById('webhookUrlInput').value, lastMessageId: null });
                saveWebhooks();
                renderWebhookList();
                webhookForm.reset();
                modal.classList.remove('active');
            });

            // Webhook card actions (delegated)
            webhookList.addEventListener('click', (e) => {
                const button = e.target.closest('button');
                if (!button) return;
                const id = Number(button.dataset.id);

                if (button.classList.contains('delete-btn')) {
                    if (confirm('Are you sure?')) { webhooks = webhooks.filter(wh => wh.id !== id); saveWebhooks(); renderWebhookList(); }
                } else if (button.classList.contains('announce-btn')) {
                    prepareAnnouncementForm(id, false);
                } else if (button.classList.contains('edit-last-btn')) {
                    prepareAnnouncementForm(id, true);
                }
            });

            // Spotlight hover effect on cards
            webhookList.addEventListener('pointermove', e => {
                const card = e.target.closest('.webhook-card');
                if (!card) return;
                const rect = card.getBoundingClientRect();
                card.style.setProperty('--x', e.clientX - rect.left + 'px');
                card.style.setProperty('--y', e.clientY - rect.top + 'px');
            });
            
            // Import/Export
            document.getElementById('exportBtn').addEventListener('click', handleExport);
            document.getElementById('importBtn').addEventListener('click', () => document.getElementById('importFileInput').click());
            document.getElementById('importFileInput').addEventListener('change', handleImport);

            // Announcement Form
            document.getElementById('backToDashboardBtn').addEventListener('click', () => showView('webhookListContainer'));
            document.getElementById('addFieldBtn').addEventListener('click', () => {
                const fieldId = Date.now();
                document.getElementById('fieldsContainer').insertAdjacentHTML('beforeend', `
                    <div class="field-item" id="field-${fieldId}"><button type="button" class="remove-field" onclick="this.parentElement.remove()">X</button><div><label>Field Name</label><input type="text" class="field-name"></div><div><label>Field Value</label><input type="text" class="field-value"></div><div class="inline-checkbox"><input type="checkbox" id="inline-${fieldId}" class="field-inline"><label for="inline-${fieldId}">Inline?</label></div></div>`);
            });
            announcementForm.addEventListener('submit', handleSendAnnouncement);

            // --- INITIALIZATION ---
            loadWebhooks();
            renderWebhookList();
            showView('webhookListContainer');
        });
    </script>
</body>
</html>
