<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Announcer Dashboard</title>
    <link rel="stylesheet" href="style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="background-container">
        <div class="stars"></div>
        <div class="twinkling"></div>
        <div class="clouds"></div>
    </div>
    
    <div class="container">
        <div class="dashboard-container">

            <!-- VIEW 1: Webhook List (Main View) -->
            <div id="webhookListContainer">
                <div class="dashboard-header">
                    <h1 class="title-glow" style="font-size: 2em; margin: 0;">My Webhooks</h1>
                    <button id="showAddWebhookModalBtn" class="cool-button"><span>+ Add New</span></button>
                </div>
                <div id="webhookList">
                    <!-- Webhook cards will be injected here by JavaScript -->
                </div>
                <div id="noWebhooksMessage" class="hidden">
                    <h2>No webhooks found.</h2>
                    <p>Click "+ Add New" to get started!</p>
                </div>
            </div>

            <!-- VIEW 2: Announcement Form -->
            <div id="announcementFormContainer" class="hidden">
                <div class="dashboard-header">
                     <h2 id="formTitle" style="margin: 0;">Create Announcement</h2>
                     <button id="backToDashboardBtn" class="cool-button btn-danger"><span>&larr; Back</span></button>
                </div>
                <form id="announcementForm">
                    <!-- Content -->
                    <div class="form-section">
                        <label for="messageContent">Message Content (Optional)</label>
                        <textarea id="messageContent" placeholder="You can use @everyone, @here, etc."></textarea>
                    </div>
                    <!-- Embed -->
                    <div class="form-section">
                        <h3>Embed Message (Optional)</h3>
                        <label for="embedTitle">Title</label><input type="text" id="embedTitle">
                        <label for="embedDescription">Description</label><textarea id="embedDescription" placeholder="Supports Markdown. e.g., **bold**"></textarea>
                        <label for="embedAuthor">Author</label><input type="text" id="embedAuthor">
                        <label for="embedAuthorIcon">Author Icon URL</label><input type="url" id="embedAuthorIcon">
                        <label for="embedImage">Image URL</label><input type="url" id="embedImage">
                        <label for="embedThumbnail">Thumbnail URL</label><input type="url" id="embedThumbnail">
                        <label for="embedFooter">Footer</label><input type="text" id="embedFooter">
                        <label for="embedFooterIcon">Footer Icon URL</label><input type="url" id="embedFooterIcon">
                    </div>
                    <!-- Fields -->
                    <div class="form-section">
                        <h3>Embed Fields</h3>
                        <div id="fieldsContainer" class="field-container"></div>
                        <div class="button-group">
                            <button type="button" id="addFieldBtn" class="cool-button"><span>Add Field</span></button>
                        </div>
                    </div>
                    <div class="button-group">
                        <button type="submit" class="cool-button"><span>Send Announcement</span></button>
                    </div>
                </form>
            </div>
            
            <div id="statusMessage" class="status-message hidden"></div>
        </div>
    </div>

    <!-- MODAL for adding/editing a webhook -->
    <div id="webhookModal" class="modal-overlay">
        <div class="glass-card modal-content">
            <h2 id="modalTitle">Add New Webhook</h2>
            <form id="webhookForm">
                <div class="input-group">
                    <input type="url" id="webhookUrlInput" required>
                    <label>Webhook URL</label>
                </div>
                <div class="input-group">
                    <input type="text" id="webhookNameInput" required>
                    <label>Display Name (e.g., #announcements)</label>
                </div>
                <div class="button-group">
                    <button type="submit" class="cool-button"><span>Save</span></button>
                    <button type="button" id="closeModalBtn" class="cool-button btn-danger"><span>Cancel</span></button>
                </div>
            </form>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- STATE MANAGEMENT ---
            let webhooks = [];
            let activeWebhookId = null;
            let isEditingLastMessage = false;

            // --- DOM ELEMENTS ---
            const webhookListContainer = document.getElementById('webhookListContainer');
            const webhookList = document.getElementById('webhookList');
            const noWebhooksMessage = document.getElementById('noWebhooksMessage');
            const announcementFormContainer = document.getElementById('announcementFormContainer');
            const announcementForm = document.getElementById('announcementForm');
            const modal = document.getElementById('webhookModal');
            const webhookForm = document.getElementById('webhookForm');
            const statusMessage = document.getElementById('statusMessage');
            const formTitle = document.getElementById('formTitle');

            // --- DATA FUNCTIONS ---
            const loadWebhooks = () => {
                try {
                    const storedWebhooks = JSON.parse(localStorage.getItem('webhooks')) || [];
                    webhooks = storedWebhooks;
                } catch (e) {
                    webhooks = [];
                }
            };

            const saveWebhooks = () => {
                localStorage.setItem('webhooks', JSON.stringify(webhooks));
            };

            const getWebhookById = (id) => webhooks.find(wh => wh.id === id);

            // --- UI RENDERING & VIEW MANAGEMENT ---
            const renderWebhookList = () => {
                webhookList.innerHTML = '';
                if (webhooks.length === 0) {
                    noWebhooksMessage.classList.remove('hidden');
                } else {
                    noWebhooksMessage.classList.add('hidden');
                    webhooks.forEach((wh, index) => {
                        const card = document.createElement('div');
                        card.className = 'webhook-card';
                        card.style.animationDelay = `${index * 50}ms`;
                        card.innerHTML = `
                            <h3>${wh.name}</h3>
                            <p>${wh.url}</p>
                            <div class="card-actions">
                                <button class="cool-button announce-btn" data-id="${wh.id}"><span>Announce</span></button>
                                ${wh.lastMessageId ? `<button class="cool-button edit-last-btn" data-id="${wh.id}"><span>Edit Last</span></button>` : ''}
                                <button class="cool-button btn-danger delete-btn" data-id="${wh.id}"><span>Delete</span></button>
                            </div>
                        `;
                        webhookList.appendChild(card);
                    });
                }
            };
            
            const showView = (view) => {
                webhookListContainer.classList.add('hidden');
                announcementFormContainer.classList.add('hidden');
                document.getElementById(view).classList.remove('hidden');
            };

            const showStatus = (message, type = 'success') => {
                statusMessage.textContent = message;
                statusMessage.className = `status-message status-${type}`;
                statusMessage.classList.remove('hidden');
                setTimeout(() => statusMessage.classList.add('hidden'), 4000);
            };

            // --- MODAL FUNCTIONS ---
            const openModal = () => modal.classList.add('active');
            const closeModal = () => modal.classList.remove('active');

            // --- FORM & ANNOUNCEMENT LOGIC ---
            const addField = () => {
                const fieldId = Date.now();
                const fieldHTML = `
                    <div class="field-item" id="field-${fieldId}">
                        <button type="button" class="remove-field" onclick="document.getElementById('field-${fieldId}').remove()">X</button>
                        <div>
                            <label>Field Name</label>
                            <input type="text" class="field-name" placeholder="Title of the field">
                        </div>
                        <div>
                            <label>Field Value</label>
                            <input type="text" class="field-value" placeholder="Content of the field">
                        </div>
                        <div class="inline-checkbox">
                            <input type="checkbox" id="inline-${fieldId}" class="field-inline"><label for="inline-${fieldId}">Inline?</label>
                        </div>
                    </div>`;
                document.getElementById('fieldsContainer').insertAdjacentHTML('beforeend', fieldHTML);
            };

            const prepareAnnouncementForm = (webhookId, isEditing = false) => {
                activeWebhookId = webhookId;
                isEditingLastMessage = isEditing;
                const webhook = getWebhookById(webhookId);
                
                formTitle.textContent = isEditing ? `Edit last in: ${webhook.name}` : `Announce to: ${webhook.name}`;
                announcementForm.reset();
                document.getElementById('fieldsContainer').innerHTML = '';

                if (isEditing && !webhook.lastMessageId) {
                    showStatus('No last message found to edit for this webhook!', 'error');
                    return;
                }
                showView('announcementFormContainer');
            };

            const handleSendAnnouncement = async (e) => {
                e.preventDefault();
                const webhook = getWebhookById(activeWebhookId);
                if (!webhook) return;

                let webhookUrl = webhook.url;
                const messageId = webhook.lastMessageId;

                const payload = { content: document.getElementById('messageContent').value || null, embeds: [] };
                const embed = {
                    title: document.getElementById('embedTitle').value, description: document.getElementById('embedDescription').value, color: 16711724, // Red color
                    author: { name: document.getElementById('embedAuthor').value, icon_url: document.getElementById('embedAuthorIcon').value },
                    image: { url: document.getElementById('embedImage').value }, thumbnail: { url: document.getElementById('embedThumbnail').value },
                    footer: { text: document.getElementById('embedFooter').value, icon_url: document.getElementById('embedFooterIcon').value },
                    fields: []
                };

                document.querySelectorAll('.field-item').forEach(item => {
                    const name = item.querySelector('.field-name').value;
                    const value = item.querySelector('.field-value').value;
                    const inline = item.querySelector('.field-inline').checked;
                    if (name && value) embed.fields.push({ name, value, inline });
                });

                if (Object.values(embed).some(val => (typeof val === 'string' && val) || (Array.isArray(val) && val.length > 0) || (typeof val === 'object' && Object.values(val).some(v => v)))) {
                    payload.embeds.push(embed);
                }

                if (!payload.content && payload.embeds.length === 0) {
                    return showStatus('You must provide some content or embed data!', 'error');
                }

                try {
                    let method = 'POST';
                    if (isEditingLastMessage && messageId) {
                        method = 'PATCH';
                        webhookUrl += `/messages/${messageId}`;
                    } else {
                        webhookUrl += '?wait=true';
                    }

                    const response = await fetch(webhookUrl, {
                        method,
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        if (method === 'POST') {
                            const data = await response.json();
                            webhook.lastMessageId = data.id;
                            saveWebhooks();
                        }
                        showStatus(isEditingLastMessage ? 'Message edited successfully!' : 'Announcement sent successfully!', 'success');
                        showView('webhookListContainer');
                        renderWebhookList();
                    } else {
                        const errorData = await response.json();
                        showStatus(`Error: ${JSON.stringify(errorData.message || errorData)}`, 'error');
                    }
                } catch (error) {
                    showStatus('A network error occurred. Check the console and your webhook URL.', 'error');
                }
            };

            // --- EVENT LISTENERS ---
            document.getElementById('showAddWebhookModalBtn').addEventListener('click', openModal);
            document.getElementById('closeModalBtn').addEventListener('click', closeModal);
            modal.addEventListener('click', (e) => { if(e.target === modal) closeModal(); });

            webhookForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const name = document.getElementById('webhookNameInput').value;
                const url = document.getElementById('webhookUrlInput').value;
                webhooks.push({ id: Date.now(), name, url, lastMessageId: null });
                saveWebhooks();
                renderWebhookList();
                webhookForm.reset();
                closeModal();
            });

            webhookList.addEventListener('click', (e) => {
                const button = e.target.closest('button');
                if (!button) return;

                const id = Number(button.dataset.id);

                if (button.classList.contains('delete-btn')) {
                    if (confirm('Are you sure you want to delete this webhook?')) {
                        webhooks = webhooks.filter(wh => wh.id !== id);
                        saveWebhooks();
                        renderWebhookList();
                    }
                } else if (button.classList.contains('announce-btn')) {
                    prepareAnnouncementForm(id, false);
                } else if (button.classList.contains('edit-last-btn')) {
                    prepareAnnouncementForm(id, true);
                }
            });
            
            document.getElementById('backToDashboardBtn').addEventListener('click', () => showView('webhookListContainer'));
            document.getElementById('addFieldBtn').addEventListener('click', addField);
            announcementForm.addEventListener('submit', handleSendAnnouncement);

            // --- INITIALIZATION ---
            loadWebhooks();
            renderWebhookList();
            showView('webhookListContainer');
        });
    </script>
</body>
    </html>
